
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Bot – RAG</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,.04); }
    input, textarea, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    label { font-size: 12px; color: #555; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  </style>
</head>
<body>
  <h1>Admin del Bot – RAG & Conectores</h1>
  <div class="card">
    <div class="row">
      <div>
        <label>ADMIN_TOKEN</label>
        <input id="token" placeholder="pegá tu token aquí" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:10px;">
        <a href="/ui/admin.html">Volver a Config</a>
        <button onclick="loadDocs()">Cargar Documentos</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Cargar documento en RAG</h2>
    <div class="row">
      <div><label>Título</label><input id="title"/></div>
      <div><label>Tags (coma separadas)</label><input id="tags"/></div>
    </div>
    <label style="margin-top:10px; display:block;">Contenido (texto/markdown)</label>
    <textarea id="text" rows="10" placeholder="Pegá acá el contenido"></textarea>
    <div style="margin-top:10px;"><button onclick="uploadDoc()">Subir</button></div>
  </div>

  <div class="card">
    <h2>Documentos</h2>
    <table>
      <thead><tr><th>ID</th><th>Título</th><th>Tags</th><th>Chunks</th><th>Creado</th><th></th></tr></thead>
      <tbody id="docs"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Base externa (solo lectura)</h2>
    <p>Seteá una conexión Postgres **read-only** y una lista blanca de consultas <em>SELECT</em> que el bot puede ejecutar.</p>
    <label>EXTERNAL_DB_URL</label>
    <input id="extUrl" placeholder="postgres://user:pass@host:5432/db"/>
    <label>Allowed SQL (una por línea; deben empezar con SELECT)</label>
    <textarea id="extSQL" rows="6" placeholder="SELECT sku,name,price,stock,category FROM products_view;"></textarea>
    <div style="margin-top:10px;"><button onclick="saveExternal()">Guardar</button><button onclick="loadExternal()">Recargar</button></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const H = () => ({ 'Content-Type': 'application/json', 'x-admin-token': $('#token').value.trim() });

async function uploadDoc(){
  const title = $('#title').value.trim();
  const tags = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const text = $('#text').value;
  const res = await fetch('/rag/docs', { method:'POST', headers:H(), body: JSON.stringify({ title, tags, text }) });
  if(!res.ok){ alert('Error subiendo: '+res.status); return; }
  $('#title').value = ''; $('#tags').value=''; $('#text').value='';
  loadDocs();
}

async function loadDocs(){
  const res = await fetch('/rag/docs', { headers:H() });
  if(!res.ok){ alert('Error listando: '+res.status); return; }
  const data = await res.json();
  const tbody = $('#docs'); tbody.innerHTML = '';
  data.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.id}</td><td>${d.title}</td><td>${(d.tags||[]).join(', ')}</td><td>${d.chunks||0}</td><td>${new Date(d.created_at).toLocaleString()}</td>
      <td><button onclick="delDoc(${d.id})">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
}

async function delDoc(id){
  const ok = confirm('¿Eliminar doc '+id+'?');
  if(!ok) return;
  const res = await fetch('/rag/docs/'+id, { method:'DELETE', headers:H() });
  if(!res.ok){ alert('Error eliminando: '+res.status); return; }
  loadDocs();
}

async function saveExternal(){
  const url = $('#extUrl').value.trim();
  const allowed_sql = $('#extSQL').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const res = await fetch('/rag/external-db', { method:'POST', headers:H(), body: JSON.stringify({ url, allowed_sql }) });
  if(!res.ok){ alert('Error guardando: '+res.status); return; }
  alert('Guardado');
}

async function loadExternal(){
  const res = await fetch('/rag/external-db', { headers:H() });
  if(!res.ok){ alert('Error cargando DB externa: '+res.status); return; }
  const data = await res.json();
  $('#extUrl').value = data.external_db_url || '';
  try{
    const list = JSON.parse(data.external_allowed_sql || '[]');
    $('#extSQL').value = Array.isArray(list) ? list.join('\n') : '';
  }catch(e){ $('#extSQL').value=''; }
}
</script>
</body>
</html>
